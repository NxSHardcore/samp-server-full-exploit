#include "main.hpp"

namespace net
{
//#ifndef _WIN32
	unsigned short csum(unsigned short *buf, int count)
	{
		register unsigned long sum = 0;
		while (count > 1) { sum += *buf++; count -= 2; }
		if (count > 0) { sum += *(unsigned char *)buf; }
		while (sum >> 16) { sum = (sum & 0xffff) + (sum >> 16); }
		return (unsigned short)(~sum);
	}

	void setup_ip_header(struct iphdr *iph)
	{
		iph->ihl = 5;
		iph->version = 4;
		iph->tos = 0;
		iph->tot_len = sizeof(struct iphdr) + sizeof(struct udphdr) + 4;
		iph->id = htonl(54321);
		iph->frag_off = 0;
		iph->ttl = 87;
		iph->protocol = IPPROTO_UDP;
		iph->check = 0;
	}

	void setup_udp_header(struct udphdr *udph)
	{
		udph->source = htons(50000 + rand_cmwc() % 65535);
		udph->dest = htons(server_checker::ms_siPort);
		udph->check = 0;
		memcpy((void*)udph + sizeof(struct udphdr), "\x08\x1e\x77\xda", 4);
		udph->len = htons(sizeof(struct udphdr) + 4);
	}
//#endif
};